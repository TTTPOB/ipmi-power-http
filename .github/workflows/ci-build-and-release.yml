name: ci-build-and-release

on:
  push:
    branches: ["main", "master"]
    tags: ["*"]
  pull_request:
  workflow_dispatch:

# Avoid piling up runs on the same branch; do not cancel tag builds.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ !startsWith(github.ref, 'refs/tags/') }}

env:
  BIN_NAME: ipmi-power-http
  CARGO_BUILD_ARGS: ""
  CARGO_TERM_COLOR: always

permissions:
  contents: read

jobs:
  build:
    name: build (${{ matrix.artifact_id }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux musl
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-musl
            artifact_id: linux-x86_64-musl
            archive_ext: tar.gz
            needs_musl: true

          - os: ubuntu-22.04
            target: aarch64-unknown-linux-musl
            artifact_id: linux-aarch64-musl
            archive_ext: tar.gz
            use_cross: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: ${{ matrix.target }}

      - name: Install musl tools (Linux musl only)
        if: ${{ matrix.needs_musl }}
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
        shell: bash

      - name: Install cross (aarch64 musl only)
        if: ${{ matrix.use_cross }}
        uses: taiki-e/cache-cargo-install-action@v2
        with:
          tool: cross

      - name: Build (cross)
        if: ${{ matrix.use_cross }}
        run: |
          set -euxo pipefail
          cross build --release --locked --target "${{ matrix.target }}" $CARGO_BUILD_ARGS
        shell: bash

      - name: Build (cargo)
        if: ${{ !matrix.use_cross }}
        run: |
          set -euxo pipefail
          cargo build --release --locked --target "${{ matrix.target }}" $CARGO_BUILD_ARGS
        shell: bash

      - name: Package (tar.gz)
        id: package_nix
        if: ${{ matrix.archive_ext == 'tar.gz' }}
        run: |
          set -euxo pipefail
          mkdir -p dist

          BIN_PATH="target/${{ matrix.target }}/release/${BIN_NAME}"
          test -f "$BIN_PATH"

          cp "$BIN_PATH" "dist/${BIN_NAME}"

          if command -v strip >/dev/null 2>&1; then
            strip "dist/${BIN_NAME}" || true
          fi

          ASSET="dist/${BIN_NAME}-${GITHUB_REF_NAME}-${{ matrix.artifact_id }}.tar.gz"
          tar -C dist -czf "$ASSET" "${BIN_NAME}"
          rm -f "dist/${BIN_NAME}"

          echo "asset_path=$ASSET" >> "$GITHUB_OUTPUT"
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BIN_NAME }}-${{ github.ref_name }}-${{ matrix.artifact_id }}
          path: ${{ steps.package_nix.outputs.asset_path }}
          if-no-files-found: error
          compression-level: 0
          retention-days: 14

  release:
    name: create-release
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Create (or update) GitHub Release and upload assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euxo pipefail
          TAG="${GITHUB_REF_NAME}"

          ls -la dist

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" dist/* --clobber
          else
            gh release create "$TAG" dist/* \
              --title "$TAG" \
              --generate-notes
          fi
        shell: bash
